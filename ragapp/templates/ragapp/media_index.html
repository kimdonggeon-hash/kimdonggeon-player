{% extends "ragapp/_base_feature.html" %}
{% load static %}
{% block title %}ì´ë¯¸ì§€ ëª¨ì•„ë‘ê¸°{% endblock %}
{% block content %}

<style>
  /* --- minimal, pretty, self-contained --- */
  .mi-wrap{max-width:1100px;margin:0 auto;display:grid;gap:16px}
  .mi-card{background:var(--card-bg,#0f172a);border:1px solid var(--line,rgba(148,163,184,.18));
           border-radius:16px;padding:16px}
  .mi-title{font-size:20px;margin:0 0 10px}
  .mi-muted{color:#94a3b8}
  .mi-row{display:grid;gap:10px}
  .mi-hint{font-size:13px;color:#94a3b8;margin-top:6px}
  .mi-btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .mi-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line,rgba(148,163,184,.18));
          background:#111b34;color:#e5e7eb;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  .mi-btn.primary{background:linear-gradient(90deg,#6366f1,#4f46e5);border-color:transparent}
  .mi-btn.ghost{background:#0b1326}
  .mi-check{display:inline-flex;gap:8px;align-items:center;margin-top:8px}
  /* dropzone */
  .mi-drop{display:flex;align-items:center;justify-content:center;text-align:center;min-height:160px;
           border:1.5px dashed var(--line,rgba(148,163,184,.28));border-radius:14px;background:#0b1326;padding:16px;
           transition:.15s ease-in-out}
  .mi-drop:hover{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.25)}
  .mi-drop.is-drag{border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25)}
  .mi-drop input[type=file]{display:none}
  .mi-drop .mi-icon{font-size:28px;margin-bottom:6px}
  /* preview grid */
  .mi-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));margin-top:12px}
  .mi-item{border:1px solid var(--line,rgba(148,163,184,.18));border-radius:12px;overflow:hidden;background:#0b1326}
  .mi-thumb{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
  .mi-meta{padding:8px}
  .mi-cap{font-size:13px;line-height:1.35;word-break:break-all}
  .mi-tag{font-size:12px;color:#94a3b8}
  /* result chips */
  .mi-chip{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.25);color:#94a3b8}
  .mi-chip.ok{border-color:rgba(34,197,94,.35);color:#86efac}
  .mi-chip.fail{border-color:rgba(239,68,68,.35);color:#fecaca}

  /* --- ì‚¬ìš© ì„¤ëª…ì„œ ì¹´ë“œ --- */
  .mi-help-card{
    background:
      radial-gradient(circle at top left, rgba(56,189,248,.10), transparent 55%),
      radial-gradient(circle at bottom right, rgba(129,140,248,.18), transparent 55%),
      #020617;
    border-radius:18px;
    border:1px solid rgba(148,163,184,.45);
    padding:18px 20px;
    box-shadow:0 18px 45px rgba(15,23,42,.75);
    color:#e5e7eb;
  }
  .mi-help-header{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .mi-help-title{display:flex;align-items:center;gap:8px}
  .mi-help-title h2{margin:0;font-size:15px;font-weight:700;letter-spacing:.02em;color:#f9fafb}
  .mi-help-pill{
    display:inline-flex;align-items:center;justify-content:center;
    padding:2px 8px;border-radius:999px;
    font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.14em;
    background:linear-gradient(90deg,#38bdf8,#6366f1);
    color:#020617;
  }
  .mi-help-sub{margin:0;font-size:12px;color:#9ca3af}

  .mi-help-body{
    display:grid;
    grid-template-columns:minmax(0,2.1fr) minmax(0,1.3fr);
    gap:18px;
    margin-top:6px;
  }
  @media (max-width:900px){
    .mi-help-body{grid-template-columns:minmax(0,1fr)}
  }

  .mi-help-steps{
    margin:0;
    padding-left:18px;
    display:flex;
    flex-direction:column;
    gap:8px;
    font-size:13px;
    color:#d1d5db;
  }
  .mi-help-steps li strong{color:#e5e7eb}
  .mi-help-steps li em{font-style:normal;color:#a5b4fc}

  .mi-help-notes{
    padding:12px 13px 10px;
    border-radius:14px;
    background:rgba(15,23,42,.96);
    border:1px dashed rgba(148,163,184,.7);
  }
  .mi-help-notes h3{
    margin:0 0 6px;
    font-size:13px;font-weight:600;color:#e5e7eb;
  }
  .mi-help-notes ul{
    margin:0;
    padding-left:16px;
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:12px;
    color:#9ca3af;
  }
</style>

<div class="mi-wrap">

  <section class="mi-card">
    <h1 class="mi-title">ì´ë¯¸ì§€ ëª¨ì•„ë‘ê¸°</h1>
    {% if error %}<div class="fx-alert error">âŒ {{ error }}</div>{% endif %}

    {% if not allow_upload %}
      <div class="fx-alert warn">ì§€ê¸ˆì€ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦´ ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.</div>
    {% else %}
      <form id="miForm" class="mi-row" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- ë“œë˜ê·¸&ë“œë¡­ + í´ë¦­ ì—…ë¡œë“œ -->
        <label id="miDrop" class="mi-drop">
          <input id="miInput" type="file" name="images" accept="image/*" multiple required />
          <div>
            <div class="mi-icon">ğŸ–¼ï¸</div>
            <div><b>ì—¬ê¸°ë¡œ ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ ëˆŒëŸ¬ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”</b></div>
            <div class="mi-hint">ìµœëŒ€ {{ max_files }}ì¥ Â· í•œ ì¥ë‹¹ {{ max_file_mb }}MBê¹Œì§€</div>
          </div>
        </label>

        <label class="mi-check">
          <input type="checkbox" name="caption_from_name" value="1"/>
          <span class="mi-muted">íŒŒì¼ ì´ë¦„ì„ ì‚¬ì§„ ì„¤ëª…ìœ¼ë¡œ ê°™ì´ ì €ì¥í•˜ê¸°</span>
        </label>

        <!-- ì„ íƒí•œ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
        <div id="miPreview" class="mi-grid" aria-live="polite"></div>

        <div class="mi-btnbar">
          <button class="mi-btn primary" type="submit">ì‚¬ì§„ ì €ì¥í•˜ê¸°</button>
          <a class="mi-btn ghost" href="{% url 'media_search' %}">ğŸ” ë§ë¡œ ì‚¬ì§„ ì°¾ê¸°</a>
        </div>
      </form>
    {% endif %}
  </section>

  <!-- âœ… ì‚¬ìš© ì„¤ëª…ì„œ ì¹´ë“œ -->
  <section class="mi-help-card" aria-label="ì´ë¯¸ì§€ ëª¨ì•„ë‘ê¸° ì‚¬ìš© ì•ˆë‚´">
    <div class="mi-help-header">
      <div class="mi-help-title">
        <span class="mi-help-pill">Guide</span>
        <h2>ì²˜ìŒ ì˜¤ì…¨ë‹¤ë©´ ì´ë ‡ê²Œ ì‚¬ìš©í•´ ë³´ì„¸ìš”</h2>
      </div>
      <p class="mi-help-sub">
        ì´ í™”ë©´ì€ ì‚¬ì§„ì„ ë¯¸ë¦¬ ì˜¬ë ¤ ë‘ê³ , ë‚˜ì¤‘ì— <b>ë§ì´ë‚˜ í‚¤ì›Œë“œë¡œ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆê²Œ</b> ëª¨ì•„ë‘ëŠ” ê³µê°„ì´ì—ìš”.
      </p>
    </div>

    <div class="mi-help-body">
      <ol class="mi-help-steps">
        <li>
          <strong>ì˜¬ë¦¬ê³  ì‹¶ì€ ì‚¬ì§„ ì„ íƒí•˜ê¸°</strong><br />
          ìœ„ì— ìˆëŠ” í° ìƒìì— ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜, ìƒìë¥¼ ëˆŒëŸ¬ì„œ íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.  
          ì—¬ëŸ¬ ì¥ì„ í•œ ë²ˆì— ì˜¬ë ¤ë„ ê´œì°®ì•„ìš”. (ìµœëŒ€ {{ max_files }}ì¥ Â· í•œ ì¥ë‹¹ {{ max_file_mb }}MB)
        </li>
        <li>
          <strong>ì‚¬ì§„ ì„¤ëª… ìë™ìœ¼ë¡œ ë„£ê¸° (ì„ íƒ)</strong><br />
          <em>â€œíŒŒì¼ ì´ë¦„ì„ ì‚¬ì§„ ì„¤ëª…ìœ¼ë¡œ ê°™ì´ ì €ì¥í•˜ê¸°â€</em>ë¥¼ ì¼œë©´  
          íŒŒì¼ ì´ë¦„ì´ ì‚¬ì§„ ì„¤ëª…ìœ¼ë¡œ í•¨ê»˜ ì €ì¥ë¼ìš”.  
          ì˜ˆ: <em>ë…¸ì„_ë°”ë‹¤.png</em> â†’ ë‚˜ì¤‘ì— â€œë…¸ì„ ë°”ë‹¤â€ë¡œ ì°¾ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
        </li>
        <li>
          <strong>ì‚¬ì§„ ì €ì¥í•˜ê¸° ë²„íŠ¼ ëˆ„ë¥´ê¸°</strong><br />
          <em>â€œì‚¬ì§„ ì €ì¥í•˜ê¸°â€</em> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„œë¹„ìŠ¤ê°€ ì‚¬ì§„ì„ ì½ê³ ,  
          ë‚˜ì¤‘ì— ê²€ìƒ‰ì—ì„œ ë°”ë¡œ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ë’¤ì—ì„œ ì •ë¦¬í•´ ë‘¡ë‹ˆë‹¤.  
          ì‚¬ì§„ì´ ë§ìœ¼ë©´ ì¡°ê¸ˆ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”.
        </li>
        <li>
          <strong>ê²€ìƒ‰ í™”ë©´ì—ì„œ ì˜ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•˜ê¸°</strong><br />
          ì €ì¥ì´ ëë‚œ ë’¤ <em>â€œë§ë¡œ ì‚¬ì§„ ì°¾ê¸°â€</em> ë²„íŠ¼ì„ ëˆŒëŸ¬  
          ë³´ê³  ì‹¶ì€ ì¥ë©´ì„ ë¬¸ì¥ìœ¼ë¡œ ì ì–´ ë³´ì„¸ìš”.  
          ë°©ê¸ˆ ì˜¬ë¦° ì‚¬ì§„ì´ ê²€ìƒ‰ ê²°ê³¼ì— ì˜ ë‚˜ì˜¤ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </li>
      </ol>

      <div class="mi-help-notes">
        <h3>ì£¼ì˜ & ì‘ì€ íŒ</h3>
        <ul>
          <li>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸, ê±´ê°• ì •ë³´ì²˜ëŸ¼ <b>ê°œì¸ì •ë³´ê°€ ë“¤ì–´ê°„ ì‚¬ì§„</b>ì€ ì˜¬ë¦¬ì§€ ì•ŠëŠ” ê²ƒì„ ì¶”ì²œë“œë ¤ìš”.</li>
          <li>ê°™ì€ ì‚¬ì§„ì„ ì—¬ëŸ¬ ë²ˆ ì˜¬ë¦¬ë©´ <b>ì¤‘ë³µìœ¼ë¡œ ì €ì¥</b>ë  ìˆ˜ ìˆì–´ìš”.</li>
          <li>ë„ˆë¬´ í° íŒŒì¼ì´ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì€ ìë™ìœ¼ë¡œ ì €ì¥ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ìš”.</li>
          <li>ì €ì¥ì´ ì•ˆ ëœ ì‚¬ì§„ì´ ìˆë‹¤ë©´, ì•„ë˜ <em>ì €ì¥ ê²°ê³¼</em> ì˜ì—­ì—ì„œ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</li>
        </ul>
      </div>
    </div>
  </section>

  {% if cards %}
  <section class="mi-card">
    <div class="mi-btnbar" style="justify-content:space-between;align-items:center">
      <div class="mi-muted">ì €ì¥ ê²°ê³¼</div>
      <div>
        <span class="mi-chip ok">ì €ì¥ ì„±ê³µ {{ ok }}</span>
        <span class="mi-chip fail" style="margin-left:6px">ì €ì¥ ì‹¤íŒ¨ {{ fail }}</span>
      </div>
    </div>

    <div class="mi-grid" style="margin-top:12px">
      {% for c in cards %}
        <div class="mi-item">
          {% if c.url and c.url != "(ë¹„ê³µê°œ ê²½ë¡œ)" %}
            <img class="mi-thumb"
                 src="{{ c.url }}"
                 alt="ì €ì¥ëœ ì‚¬ì§„"
                 loading="lazy"
                 onerror="this.onerror=null; this.src='{% static 'ragapp/img/placeholder.png' %}'">
          {% else %}
            <img class="mi-thumb" src="{% static 'ragapp/img/placeholder.png' %}" alt="placeholder" loading="lazy">
          {% endif %}
          <div class="mi-meta">
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
              <span class="mi-chip {% if c.status|lower == 'ok' %}ok{% else %}fail{% endif %}">{{ c.status }}</span>
              {% if c.mime %}<span class="mi-chip">{{ c.mime }}</span>{% endif %}
            </div>
            {% if c.pid %}<div class="mi-cap"><b>ì‚¬ì§„ ë²ˆí˜¸</b> {{ c.pid }}</div>{% endif %}
            {% if c.sha16 %}<div class="mi-cap"><b>ì¶”ê°€ ì •ë³´</b> {{ c.sha16 }}</div>{% endif %}
            {% if c.msg %}<div class="mi-cap mi-muted">ì•ˆë‚´: {{ c.msg }}</div>{% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

</div>

<!-- lightweight UX: drag&drop + previews (local only) -->
<script>
(function(){
  const input = document.getElementById('miInput');
  const drop  = document.getElementById('miDrop');
  const prev  = document.getElementById('miPreview');
  if(!input || !drop || !prev) return;

  const maxFiles = {{ max_files|default:10 }};
  const maxMB    = {{ max_file_mb|default:15 }};

  function renderPreview(files){
    prev.innerHTML = '';
    const slice = Array.prototype.slice.call(files, 0, maxFiles);
    slice.forEach(file=>{
      const url = URL.createObjectURL(file);
      const item = document.createElement('div');
      item.className = 'mi-item';
      item.innerHTML = `
        <img class="mi-thumb" src="${url}" alt="">
        <div class="mi-meta">
          <div class="mi-cap">${file.name}</div>
          <div class="mi-tag">${(file.size/1024/1024).toFixed(2)} MB</div>
        </div>`;
      prev.appendChild(item);
    });
  }

  input.addEventListener('change', ()=> renderPreview(input.files));

  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('is-drag'); });
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('is-drag'); });
  });
  drop.addEventListener('drop', e=>{
    const files = Array.from(e.dataTransfer.files || []).filter(f=> f.type.startsWith('image/'));
    if(!files.length) return;
    // ìš©ëŸ‰/ê°œìˆ˜ ê°„ë‹¨ ê²€ì¦
    const filtered = files.slice(0, maxFiles).filter(f=> (f.size/1024/1024) <= maxMB);
    // DataTransferë¥¼ ë§Œë“¤ì–´ inputì— ì£¼ì…
    const dt = new DataTransfer();
    filtered.forEach(f=> dt.items.add(f));
    input.files = dt.files;
    renderPreview(input.files);
  });
})();
</script>

{% endblock %}
