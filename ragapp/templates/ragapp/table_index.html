{% extends "ragapp/_base_feature.html" %}
{% block title %}í‘œ íŒŒì¼ ì €ì¥í•˜ê¸°{% endblock %}
{% block content %}

<style>
  /* ====== minimal, pretty, accessible ====== */
  .ci-wrap{max-width:1100px;margin:0 auto;display:grid;gap:16px}
  .ci-card{background:var(--card-bg,#0f172a);border:1px solid var(--line,rgba(148,163,184,.18));
           border-radius:16px;padding:18px}
  .ci-title{font-size:20px;margin:0 0 12px}
  .ci-muted{color:#94a3b8}
  .ci-err{padding:10px 12px;border-radius:10px;background:rgba(239,68,68,.08);
          border:1px solid rgba(239,68,68,.35);color:#fecaca;margin-bottom:8px}

  .ci-form{display:grid;gap:12px}
  .ci-row{display:grid;gap:10px}
  .ci-label{font-size:12px;color:#94a3b8;margin-bottom:6px}
  .ci-input,.ci-file,.ci-num{
    width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--line,rgba(148,163,184,.18));
    background:#0b1326;color:#e5e7eb;outline:none
  }
  .ci-input:focus,.ci-file:focus,.ci-num:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.25)}

  /* ë“œë˜ê·¸&ë“œë¡­ ì˜ì—­ */
  .ci-drop{display:flex;align-items:center;justify-content:center;text-align:center;min-height:140px;
           border:1.5px dashed var(--line,rgba(148,163,184,.28));border-radius:14px;background:#0b1326;padding:16px;
           transition:.15s ease-in-out}
  .ci-drop:hover{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.20)}
  .ci-drop.is-drag{border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.20)}
  .ci-drop input[type=file]{display:none}

  .ci-btnbar{display:flex;gap:8px;flex-wrap:wrap}
  .ci-btn{
    padding:10px 14px;border-radius:10px;border:1px solid var(--line,rgba(148,163,184,.18));
    background:#111b34;color:#e5e7eb;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;cursor:pointer
  }
  .ci-btn.primary{background:linear-gradient(90deg,#6366f1,#4f46e5);border-color:transparent}
  .ci-btn.ghost{background:#0b1326}

  /* ë¯¸ë¦¬ë³´ê¸° í‘œ */
  .ci-preview{margin-top:10px}
  .ci-twrap{overflow:auto;border-radius:12px;border:1px solid var(--line,rgba(148,163,184,.18))}
  table.ci-tbl{width:100%;border-collapse:separate;border-spacing:0}
  .ci-tbl thead th{position:sticky;top:0;background:#0f162b;border-bottom:1px solid var(--line,rgba(148,163,184,.18));
                   color:#94a3b8;text-align:left;padding:8px}
  .ci-tbl tbody td{border-bottom:1px solid rgba(148,163,184,.12);padding:8px;vertical-align:top}
  .ci-hint{font-size:13px;color:#94a3b8}
  .ci-kv{display:grid;grid-template-columns:120px 1fr;gap:8px}
  .ci-chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.25);color:#94a3b8}

  /* ====== ì‚¬ìš© ì„¤ëª…ì„œ ì¹´ë“œ ====== */
  .ci-help-card{
    background:
      radial-gradient(circle at top left, rgba(56,189,248,.10), transparent 55%),
      radial-gradient(circle at bottom right, rgba(129,140,248,.18), transparent 55%),
      #020617;
    border-radius:18px;
    border:1px solid rgba(148,163,184,.45);
    padding:18px 20px;
    box-shadow:0 18px 45px rgba(15,23,42,.75);
    color:#e5e7eb;
  }
  .ci-help-header{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .ci-help-title{display:flex;align-items:center;gap:8px}
  .ci-help-title h2{margin:0;font-size:15px;font-weight:700;letter-spacing:.02em;color:#f9fafb}
  .ci-help-pill{
    display:inline-flex;align-items:center;justify-content:center;
    padding:2px 8px;border-radius:999px;
    font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.14em;
    background:linear-gradient(90deg,#38bdf8,#6366f1);
    color:#020617;
  }
  .ci-help-sub{margin:0;font-size:12px;color:#9ca3af}

  .ci-help-body{
    display:grid;
    grid-template-columns:minmax(0,2.1fr) minmax(0,1.3fr);
    gap:18px;
    margin-top:6px;
  }
  @media (max-width:900px){
    .ci-help-body{grid-template-columns:minmax(0,1fr)}
  }

  .ci-help-steps{
    margin:0;
    padding-left:18px;
    display:flex;
    flex-direction:column;
    gap:8px;
    font-size:13px;
    color:#d1d5db;
  }
  .ci-help-steps li strong{color:#e5e7eb}
  .ci-help-steps li em{font-style:normal;color:#a5b4fc}

  .ci-help-notes{
    padding:12px 13px 10px;
    border-radius:14px;
    background:rgba(15,23,42,.96);
    border:1px dashed rgba(148,163,184,.7);
  }
  .ci-help-notes h3{
    margin:0 0 6px;
    font-size:13px;font-weight:600;color:#e5e7eb;
  }
  .ci-help-notes ul{
    margin:0;
    padding-left:16px;
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:12px;
    color:#9ca3af;
  }
</style>

<div class="ci-wrap">
  <section class="ci-card">
    <!-- ğŸ‘‡ ì œëª©ì— ì—‘ì…€ê¹Œì§€ í‘œì‹œ -->
    <h1 class="ci-title">í‘œ ë°ì´í„° ì˜¬ë ¤ë‘ê¸° (ì—‘ì…€Â·CSV)</h1>

    {% if error %}<div class="ci-err" role="alert">âŒ {{ error }}</div>{% endif %}
    {% if not allow_upload %}
      <div class="ci-err">ì§€ê¸ˆì€ íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.</div>
    {% else %}

    <form id="ciForm" class="ci-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="ci-row">
        <div>
          <div class="ci-label">ì´ í‘œë¥¼ ë¶€ë¥¼ ì´ë¦„</div>
          <input class="ci-input"
                 type="text"
                 name="table_name"
                 placeholder="ì˜ˆ: 2025ë…„ 4ë¶„ê¸° ë§¤ì¶œí‘œ, ê³ ê° ë¬¸ì˜ ë‚´ì—­"
                 required />
        </div>

        <div>
          <div class="ci-label">í‘œ íŒŒì¼(ì—‘ì…€Â·CSV í˜•ì‹)</div>

          <!-- ë“œë˜ê·¸&ë“œë¡­ + í´ë¦­ ì—…ë¡œë“œ -->
          <label id="ciDrop" class="ci-drop">
            <!-- ğŸ‘‡ accept ì— ì—‘ì…€ í™•ì¥ì ì¶”ê°€ -->
            <input id="ciFile" class="ci-file" type="file" name="csvfile"
                   accept=".csv,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx,.xls"
                   required />
            <div>
              <div style="font-size:28px;margin-bottom:6px">ğŸ“„</div>
              <b>ì—¬ê¸°ë¡œ ì—‘ì…€(.xlsx) ë˜ëŠ” CSV íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ ëˆŒëŸ¬ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”</b>
              <div class="ci-hint" style="margin-top:4px">CSV íŒŒì¼ì€ ìœ„ì—ì„œë¶€í„° ìµœëŒ€ {{ max_rows }}ì¤„ê¹Œì§€ ë¯¸ë¦¬ ë³¼ ìˆ˜ ìˆì–´ìš”</div>
            </div>
          </label>

          <!-- ì„ íƒ íŒŒì¼ ì •ë³´ & ë¯¸ë¦¬ë³´ê¸° -->
          <div id="ciFileInfo" class="ci-hint" style="margin-top:8px;display:none"></div>
          <div id="ciPreview" class="ci-preview" style="display:none">
            <div class="ci-hint" style="margin-bottom:6px">ë¯¸ë¦¬ë³´ê¸° (ìœ„ì—ì„œë¶€í„° 5ì¤„, CSVë§Œ ì§€ì›)</div>
            <div class="ci-twrap">
              <table class="ci-tbl">
                <thead id="ciThead"></thead>
                <tbody id="ciTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div>
          <div class="ci-label">ê°€ì ¸ì˜¬ ì¤„ ê°œìˆ˜ (0ì´ë©´ ì „ì²´)</div>
          <input class="ci-num" type="number" name="limit" min="0" max="{{ max_rows }}" value="0" />
          <div class="ci-hint" style="margin-top:6px">ìµœëŒ€ ê¶Œì¥: {{ max_rows }}ì¤„</div>
        </div>
      </div>

      <div class="ci-btnbar">
        <button class="ci-btn primary" type="submit">í‘œ ì €ì¥í•˜ê¸°</button>
        <a class="ci-btn ghost" href="{% url 'table_search' %}">ğŸ” í‘œ ë‚´ìš© ê²€ìƒ‰í•˜ê¸°</a>
        <a class="ci-btn" href="">ì…ë ¥ ì§€ìš°ê³  ë‹¤ì‹œ ì‹œì‘</a>
      </div>
    </form>
    {% endif %}
  </section>

  <!-- âœ… ì‚¬ìš© ì„¤ëª…ì„œ ì¹´ë“œ (ì—‘ì…€Â·CSV ê¸°ì¤€ ì„¤ëª…) -->
  <section class="ci-help-card" aria-label="í‘œ ë°ì´í„° ì˜¬ë ¤ë‘ê¸° ì‚¬ìš© ì•ˆë‚´">
    <div class="ci-help-header">
      <div class="ci-help-title">
        <span class="ci-help-pill">Guide</span>
        <h2>ì—‘ì…€Â·CSV í‘œë¥¼ ì˜¬ë ¤ë‘ê³  ë‚˜ì¤‘ì— ì§ˆë¬¸ìœ¼ë¡œ ì°¾ì•„ë³´ì„¸ìš”</h2>
      </div>
      <p class="ci-help-sub">
        ì´ í™”ë©´ì€ ì—‘ì…€ì´ë‚˜ CSVë¡œ ëœ <b>í‘œ íŒŒì¼</b>ì„ ì˜¬ë ¤ë‘ê³ ,  
        ë‚˜ì¤‘ì— <b>ì§ˆë¬¸ì´ë‚˜ í‚¤ì›Œë“œë¡œ ë‚´ìš©ì„ ì°¾ì•„ë³¼ ìˆ˜ ìˆë„ë¡ ì¤€ë¹„í•˜ëŠ” ê³µê°„</b>ì…ë‹ˆë‹¤.
      </p>
    </div>

    <div class="ci-help-body">
      <ol class="ci-help-steps">
        <li>
          <strong>ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ ì¤€ë¹„í•˜ê¸°</strong><br />
          ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ê·¸ëŒ€ë¡œ ì˜¬ë ¤ë„ ë˜ê³ ,  
          í•„ìš”í•˜ë‹¤ë©´ ì—‘ì…€ì—ì„œ <em>â€œë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥ â†’ CSV(UTF-8)â€</em> í˜•ì‹ìœ¼ë¡œ ì €ì¥í•´ì„œ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.
        </li>
        <li>
          <strong>ì´ í‘œë¥¼ ë¶€ë¥¼ ì´ë¦„ ì •í•˜ê¸°</strong><br />
          ì˜ˆë¥¼ ë“¤ì–´ <em>â€œê³ ê° ë¬¸ì˜ ë‚´ì—­â€</em>, <em>â€œ2025ë…„ 4ë¶„ê¸° ë§¤ì¶œí‘œâ€</em>ì²˜ëŸ¼  
          ë‚˜ì¤‘ì— ë´ë„ ì–´ë–¤ ë‚´ìš©ì¸ì§€ ì•Œ ìˆ˜ ìˆê²Œ ì´ë¦„ì„ ì ì–´ ì£¼ì„¸ìš”.
        </li>
        <li>
          <strong>í‘œ íŒŒì¼ ì˜¬ë¦¬ê¸°</strong><br />
          <em>â€œí‘œ íŒŒì¼(ì—‘ì…€Â·CSV í˜•ì‹)â€</em> ì˜ì—­ì— íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ ëˆŒëŸ¬ì„œ ì„ íƒí•˜ë©´  
          CSV íŒŒì¼ì¸ ê²½ìš° ìœ„ì—ì„œë¶€í„° ì¼ë¶€ ì¤„ì„ <b>ë¯¸ë¦¬ë³´ê¸°</b>ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
          ì—‘ì…€ íŒŒì¼ì€ ì„œë²„ì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ë©°, ì´ í™”ë©´ì—ì„œëŠ” ë¯¸ë¦¬ë³´ê¸° ì—†ì´ ë°”ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
        </li>
        <li>
          <strong>ê°€ì ¸ì˜¬ ì¤„ ê°œìˆ˜ ì •í•˜ê¸° (ì„ íƒ)</strong><br />
          ê¸°ë³¸ê°’ì¸ <em>0</em>ìœ¼ë¡œ ë‘ë©´ í‘œ ì „ì²´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.  
          ë°ì´í„°ê°€ ë„ˆë¬´ ë§ì•„ ì†ë„ê°€ ê±±ì •ë  ë•ŒëŠ” <em>ê°€ì ¸ì˜¬ ì¤„ ê°œìˆ˜</em>ë¥¼ ì¤„ì—¬ì„œ ì˜¬ë ¤ë³´ì„¸ìš”.
        </li>
        <li>
          <strong>í‘œ ì €ì¥í•˜ê¸° ë²„íŠ¼ ëˆ„ë¥´ê¸°</strong><br />
          <em>â€œí‘œ ì €ì¥í•˜ê¸°â€</em>ë¥¼ ëˆ„ë¥´ë©´ í‘œì˜ ê° ì¤„ì´ ë‚˜ì¤‘ì— ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ ì •ë¦¬ë©ë‹ˆë‹¤.  
          ì‘ì—…ì´ ëë‚˜ë©´ ì•„ë˜ <b>ì €ì¥ ê²°ê³¼</b>ì— ìš”ì•½ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
        </li>
      </ol>

      <div class="ci-help-notes">
        <h3>ì£¼ì˜ & ì‘ì€ íŒ</h3>
        <ul>
          <li>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸, ê±´ê°• ì •ë³´ì²˜ëŸ¼ <b>ë¯¼ê°í•œ ê°œì¸ì •ë³´ê°€ ë“¤ì–´ê°„ í‘œ</b>ëŠ” ì˜¬ë¦¬ì§€ ì•ŠëŠ” ê²ƒì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.</li>
          <li>íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ í˜•ì‹ì´ ë§ì§€ ì•Šìœ¼ë©´ ì¼ë¶€ ì¤„ì´ ì €ì¥ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì €ì¥ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´, ìœ„ ë©”ë‰´ì˜ <b>â€œí‘œ ë‚´ìš© ê²€ìƒ‰í•˜ê¸°â€</b>ì—ì„œ ì‹¤ì œë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.</li>
          <li>CSVì—ì„œ í•œê¸€ì´ ë¬¼ìŒí‘œ(??)ì²˜ëŸ¼ ë³´ì¸ë‹¤ë©´ ì—‘ì…€ì—ì„œ ì €ì¥í•  ë•Œ <b>UTF-8 (CSV UTF-8)</b> í˜•ì‹ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</li>
        </ul>
      </div>
    </div>
  </section>

  {% if ok %}
  <section class="ci-card">
    <h2 class="ci-title" style="margin-bottom:10px">ì €ì¥ ê²°ê³¼</h2>
    <div class="ci-kv">
      <div class="ci-muted">í‘œ ì´ë¦„</div>
      <div><span class="ci-chip">{{ table_name }}</span></div>
      <div class="ci-muted">ìƒˆë¡œ ì €ì¥ëœ ì¤„ ê°œìˆ˜</div>
      <div>{{ added }}</div>
      <div class="ci-muted">íŒŒì¼ ì´ë¦„</div>
      <div class="ci-muted">{{ filename }}</div>
    </div>
  </section>
  {% endif %}
</div>

<!-- lightweight CSV preview (first 5 rows) -->
<script>
(function(){
  const drop  = document.getElementById('ciDrop');
  const input = document.getElementById('ciFile');
  const info  = document.getElementById('ciFileInfo');
  const prev  = document.getElementById('ciPreview');
  const thead = document.getElementById('ciThead');
  const tbody = document.getElementById('ciTbody');
  if(!drop || !input) return;

  const MAX_PREVIEW_ROWS = 5;

  function setDrag(on){
    drop.classList.toggle('is-drag', !!on);
  }

  ['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); setDrag(true); });
  });
  ['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); setDrag(false); });
  });
  drop.addEventListener('drop', e=>{
    const files = Array.from(e.dataTransfer.files || []).filter(f=>{
      const n = (f.name || '').toLowerCase();
      return n.endsWith('.csv') || n.endsWith('.xlsx') || n.endsWith('.xls');
    });
    if(!files.length) return;
    const dt = new DataTransfer();
    files.slice(0,1).forEach(f=> dt.items.add(f));
    input.files = dt.files;
    showInfoAndPreview();
  });

  input.addEventListener('change', showInfoAndPreview);

  function showInfoAndPreview(){
    if(!input.files || !input.files[0]) return;
    const f = input.files[0];

    const nameLower = (f.name || '').toLowerCase();
    const isExcel = nameLower.endsWith('.xlsx') || nameLower.endsWith('.xls');
    const isCsv   = nameLower.endsWith('.csv') || (f.type && f.type.includes('csv'));

    // íŒŒì¼ ì •ë³´
    info.style.display = 'block';
    info.textContent = `${f.name} Â· ${(f.size/1024/1024).toFixed(2)} MB`;

    // ì—‘ì…€: ë¯¸ë¦¬ë³´ê¸° ì—†ì´ ì•ˆë‚´ë§Œ
    if(isExcel){
      info.textContent += ' Â· ì—‘ì…€ íŒŒì¼ì€ ì„œë²„ì—ì„œ ì²˜ë¦¬ë˜ë©°, ì´ í™”ë©´ì—ì„œëŠ” ë¯¸ë¦¬ë³´ê¸°ê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      prev.style.display = 'none';
      thead.innerHTML = '';
      tbody.innerHTML = '';
      return;
    }

    // CSVê°€ ì•„ë‹Œ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ íŒŒì¼ì´ë©´ ë¯¸ë¦¬ë³´ê¸° ìƒëµ
    if(!isCsv){
      info.textContent += ' Â· ë¯¸ë¦¬ë³´ê¸°ëŠ” CSV í˜•ì‹ì¼ ë•Œë§Œ ì§€ì›ë©ë‹ˆë‹¤.';
      prev.style.display = 'none';
      thead.innerHTML = '';
      tbody.innerHTML = '';
      return;
    }

    // CSV ë¯¸ë¦¬ë³´ê¸°
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const text = e.target.result || '';
        renderPreview(text);
      }catch(_){
        prev.style.display = 'none';
      }
    };
    reader.onerror = function(){
      prev.style.display = 'none';
    };
    reader.readAsText(f, 'utf-8');
  }

  function csvParseHeadRows(text, maxRows){
    // ê°„ë‹¨ CSV íŒŒì„œ (ë”°ì˜´í‘œ ìµœì†Œ ëŒ€ì‘)
    const lines = text.split(/\r?\n/).filter(Boolean).slice(0, maxRows + 1);
    if(!lines.length) return {header: [], rows: []};

    const parseLine = (line)=>{
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='\"'){
          if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; } else { inQ=!inQ; }
        }else if(ch===',' && !inQ){
          out.push(cur); cur='';
        }else{
          cur+=ch;
        }
      }
      out.push(cur);
      return out.map(s=>s.trim());
    };

    const header = parseLine(lines[0]);
    const rows = lines.slice(1).map(parseLine);
    return {header, rows};
  }

  function renderPreview(text){
    const {header, rows} = csvParseHeadRows(text, MAX_PREVIEW_ROWS);
    if(!header.length){ prev.style.display='none'; return; }

    thead.innerHTML = '<tr>' + header.map(h=>`<th>${escapeHtml(h||'')}</th>`).join('') + '</tr>';
    const bodyRows = rows.slice(0, MAX_PREVIEW_ROWS).map(r=>{
      return '<tr>' + header.map((_,i)=>`<td>${escapeHtml(r[i]||'')}</td>`).join('') + '</tr>';
    }).join('');
    tbody.innerHTML = bodyRows || '<tr><td class="ci-muted" style="padding:8px">ë¯¸ë¦¬ë³¼ ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    prev.style.display = 'block';
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }
})();
</script>

{% endblock %}
