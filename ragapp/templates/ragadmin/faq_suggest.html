{% extends "admin/base_site.html" %}

{% block extrastyle %}
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --dim:#6b7280; --line:#e5e7eb;
    --accent:#38bdf8; --accent-strong:#0ea5e9; --accent-soft:#e0f2fe;
    --ok:#10b981; --radius:14px;
  }
  .wrap{max-width:1100px;margin:0 auto}
  .head h1{margin:0 0 6px;font-weight:800}
  .head p{margin:0 0 14px;color:var(--dim)}

  /* ë¦¬ìŠ¤íŠ¸(í–‰ ì ‘ê¸°) */
  .list{list-style:none;margin:0;padding:0}
  .item{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
        box-shadow:0 8px 24px rgba(15,23,42,.06);margin:10px 0;overflow:hidden}
  .item details{border-radius:inherit}
  .item summary{display:flex;align-items:center;gap:12px;cursor:pointer;padding:14px 16px;list-style:none}
  .item summary::-webkit-details-marker{display:none}
  .item summary:focus-visible{outline:3px solid var(--accent);outline-offset:2px;border-radius:10px}
  .item summary .q{flex:1;font-weight:700}
  .item summary .chips{display:flex;gap:8px;align-items:center;white-space:nowrap}
  .item summary .btn-inline{margin-left:8px}
  /* ìºëŸ¿ ì•„ì´ì½˜ */
  .item summary::before{
    content:"";width:10px;height:10px;border-right:2px solid var(--accent-strong);
    border-bottom:2px solid var(--accent-strong);transform:rotate(-45deg);transition:.2s;margin-right:2px
  }
  .item[open] summary::before{transform:rotate(45deg)}

  /* ìƒì„¸ íŒ¨ë„ */
  .panel{border-top:1px solid var(--line);padding:12px 16px;background:#fff}
  .samples{display:grid;gap:10px}
  .sample{
    white-space:pre-wrap;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff
  }
  .sample-head{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}

  /* ë²„íŠ¼/ë°°ì§€ */
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);
       padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--accent),var(--accent-strong));color:#fff}
  .btn.primary:disabled{opacity:.55;cursor:not-allowed;transform:none}
  .chip{display:inline-block;padding:2px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid var(--line)}
  .chip.count{background:var(--accent-soft);color:#075985}
  .chip.bad{background:#fff1f2;color:#991b1b;border-color:#fecaca}

  .empty{color:var(--dim);text-align:center;padding:24px 8px}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="head">
    <h1>FAQ í›„ë³´ ì¶”ì²œ</h1>
    <p>ë°˜ë³µì ìœ¼ë¡œ ë§ì´ ë‚˜ì˜¨ ì§ˆë¬¸Â·ğŸ‘ ë§ì€ ì§ˆë¬¸ë¶€í„° ì •ë ¬ë©ë‹ˆë‹¤. ê° í–‰ì„ í¼ì³ ìƒ˜í”Œì„ ì„ íƒí•´ ë°”ë¡œ ìŠ¹ê²©í•˜ì„¸ìš”.</p>
  </div>

  <ul class="list">
    {% for it in suggestions %}
      {% with idx=forloop.counter %}
      <li class="item">
        <details id="item-{{ idx }}">
          <summary tabindex="0" role="button" aria-controls="panel-{{ idx }}">
            <span class="q">{{ it.question }}</span>
            <span class="chips">
              <span class="chip count">ì§ˆë¬¸ {{ it.count }}</span>
              <span class="chip bad">ğŸ‘ {{ it.bad_count }}</span>
            </span>
            {% if it.samples and it.samples.0 %}
              <!-- ìš”ì•½í–‰ì—ì„œ ë°”ë¡œ ìŠ¹ê²© (ì„ íƒëœ ë¼ë””ì˜¤ ê¸°ì¤€) -->
              <button class="btn btn-inline primary" type="button"
                      data-promote="#promote-{{ idx }}">FAQë¡œ ìŠ¹ê²©</button>
            {% else %}
              <button class="btn btn-inline" type="button" disabled>ìƒ˜í”Œ ì—†ìŒ</button>
            {% endif %}
          </summary>

          <div class="panel" id="panel-{{ idx }}">
            {% if it.samples %}
              <div class="samples" role="radiogroup" aria-label="ìƒ˜í”Œ ì„ íƒ">
                {% for s in it.samples %}
                  {% with rid="s-"|add:idx|add:"-"|add:forloop.counter %}
                  <label class="sample" for="{{ rid }}">
                    <div class="sample-head">
                      <input type="radio" id="{{ rid }}" name="sel-{{ idx }}"
                             class="sel-radio" {% if forloop.first %}checked{% endif %}
                             data-answer="{{ s|escape }}">
                      <strong>ìƒ˜í”Œ {{ forloop.counter }}</strong>
                    </div>
                    <div>{{ s }}</div>
                  </label>
                  {% endwith %}
                {% endfor %}
              </div>
            {% else %}
              <div class="empty">ìƒ˜í”Œ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endif %}

            {% if it.samples and it.samples.0 %}
              <!-- ì‹¤ì œ ì „ì†¡ í¼ (ì„ íƒ ë¼ë””ì˜¤ì˜ í…ìŠ¤íŠ¸ë¥¼ hidden textareaë¡œ ë³µì‚¬) -->
              <form id="promote-{{ idx }}" class="controls" method="post" action="{% url 'ragadmin:faq_promote' %}">
                {% csrf_token %}
                <input type="hidden" name="question" value="{{ it.question }}">
                <textarea name="answer" hidden>{{ it.samples.0 }}</textarea>
                <button class="btn primary" type="submit">ì„ íƒ ìƒ˜í”Œë¡œ ìŠ¹ê²©</button>
              </form>
            {% endif %}
          </div>
        </details>
      </li>
      {% endwith %}
    {% empty %}
      <li class="item"><div class="empty">ë°ì´í„° ì—†ìŒ</div></li>
    {% endfor %}
  </ul>
</div>

<script>
(function(){
  // 1) ìš”ì•½í–‰ ì ‘ê·¼ì„±: Enter/Spaceë¡œ ì—´ë¦¼/ë‹«í˜ ë³´ê°•
  document.querySelectorAll('.item summary').forEach(function(sum){
    sum.addEventListener('keydown', function(e){
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        const details = sum.parentElement;
        details.open = !details.open;
      }
    });
  });

  // 2) ë¼ë””ì˜¤ ì„ íƒ â†’ í•´ë‹¹ í¼ì˜ hidden textareaì— ë³µì‚¬
  const updateAnswer = (wrap) => {
    const checked = wrap.querySelector('.sel-radio:checked');
    const form = wrap.querySelector('form[id^="promote-"]');
    if (!checked || !form) return;
    const ta = form.querySelector('textarea[name="answer"]');
    if (ta) {
      // data-answerëŠ” escapeëœ í…ìŠ¤íŠ¸ë¼ innerTextì— ê·¸ëŒ€ë¡œ ë„£ì–´ì¤˜ë„ ì•ˆì „
      ta.value = checked.getAttribute('data-answer');
    }
  };

  document.querySelectorAll('.item .panel').forEach(function(panel){
    panel.addEventListener('change', function(e){
      if (e.target.classList && e.target.classList.contains('sel-radio')) {
        updateAnswer(panel);
      }
    });
    // ì´ˆê¸°ê°’ ì„¸íŒ…
    updateAnswer(panel);
  });

  // 3) ìš”ì•½í–‰ì˜ "FAQë¡œ ìŠ¹ê²©" ë²„íŠ¼ â†’ íŒ¨ë„ ë‚´ë¶€ í¼ submit
  document.querySelectorAll('button[data-promote]').forEach(function(btn){
    btn.addEventListener('click', function(){
      const form = document.querySelector(btn.dataset.promote);
      if (!form) return;
      // í¼ ì œì¶œ ì „ ìµœì‹  ì„ íƒ ë¼ë””ì˜¤ í…ìŠ¤íŠ¸ ë³µì‚¬
      updateAnswer(form.closest('.panel'));
      form.submit();
    });
  });
})();
</script>
{% endblock %}
