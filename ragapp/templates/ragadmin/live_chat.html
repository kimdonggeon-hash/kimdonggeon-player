{% load static versioned_static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì‹¤ì‹œê°„ ìƒë‹´ ì½˜ì†”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" href="{% static 'ragapp/favicon.ico' %}">
  <!-- ì• í”Œ ê°ì„± ë‹¤í¬ UI CSS -->
  <link rel="stylesheet" href="{% versioned_static 'ragapp/css/livechat_admin.css' %}">

  <!-- ìƒë‹´ ê¸°ë¡ ìƒíƒœ pill ì „ìš© (ê°€ë³ê²Œ ì˜¤ë²„ë¼ì´ë“œ) -->
  <style>
    .session-status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      min-height: 1.4em;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #a5b4fc;
      white-space: nowrap;
    }
    .session-status-pill--idle {
      opacity: 0.9;
    }
    .session-status-pill--need {
      border-color: #f97373;
      color: #fecaca;
    }
    .session-status-pill--saving {
      border-style: dashed;
      opacity: 0.95;
    }
    .session-status-pill--ok {
      border-color: #4ade80;
      color: #bbf7d0;
    }
    .session-status-pill--error {
      border-color: #f97373;
      color: #fecaca;
    }
  </style>
</head>

<body data-initial-room="{{ initial_room|default:'master' }}">
  <div class="lc-wrap">
    <header class="lc-header">
      <div class="lc-header-main">
        <h1 class="lc-header-title">ì‹¤ì‹œê°„ ìƒë‹´ ì½˜ì†”</h1>
        <p class="lc-header-sub">
          QARAGì—ì„œ ë“¤ì–´ì˜¨ ìƒë‹´ ìš”ì²­ì„ í™•ì¸í•˜ê³ , ì„ íƒí•œ ë°©ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.
        </p>

        <!-- ìƒë‹¨ ìš”ì•½ ë°” -->
        <div class="summary-bar" id="livechatSummaryBar">
          <span class="summary-pill summary-wait">
            ëŒ€ê¸° <strong id="summaryWaitCount">0</strong>ê±´
          </span>
          <span class="summary-pill summary-active">
            ì§„í–‰ <strong id="summaryActiveCount">0</strong>ê±´
          </span>
          <span class="summary-pill summary-done">
            ì˜¤ëŠ˜ ì™„ë£Œ <strong id="summaryDoneCount">0</strong>ê±´
          </span>
          <button type="button"
                  id="livechatCleanupBtn"
                  class="summary-pill summary-clean"
                  data-cleanup-url="{% url 'live_chat_cleanup' %}">
            ì˜¤ëŠ˜ ì„¸ì…˜ ì •ë¦¬
          </button>
        </div>
      </div>
    </header>

    <div class="lc-layout">
      <!-- LEFT: ì‹¤ì‹œê°„ ëŒ€ê¸° + ìµœê·¼ ì„¸ì…˜ -->
      <section class="card card-left">
        <!-- ì‹¤ì‹œê°„ ëŒ€ê¸° ëª©ë¡ -->
        <div class="sub-card">
          <div class="sub-card-header">
            <div>
              <div class="sub-card-title">ì‹¤ì‹œê°„ ëŒ€ê¸° ëª©ë¡</div>
              <div class="sub-card-sub">
                QARAGì—ì„œ â€œìƒë‹´ì‚¬ ì—°ê²°â€ì„ ëˆ„ë¥´ë©´ ì•„ë˜ì— ë°©ì´ ìƒì„±ë©ë‹ˆë‹¤.
              </div>
              <div class="lobby-summary">
                ëŒ€ê¸° ì¤‘: <strong id="livechatLobbyCount">0</strong>ê±´
              </div>
            </div>
            <div id="livechatLobbyStatus" class="lobby-status">
              ë¡œë¹„ ì—°ê²° ìƒíƒœ: <strong>ì—°ê²° ì‹œë„ ì¤‘...</strong>
            </div>
          </div>

          <div class="lc-table-wrap">
            <table class="lc-table">
              <thead>
                <tr>
                  <th style="width:26%;">ë°© / ì½”ë“œ</th>
                  <th>í˜ì´ì§€</th>
                  <th style="width:18%;">ìš”ì²­ ì‹œê°</th>
                  <th style="width:20%;text-align:right;">ë™ì‘</th>
                </tr>
              </thead>
              <tbody id="livechatLobbyBody">
                <!-- JSê°€ handoff ì´ë²¤íŠ¸ë¡œ ì±„ì›€ -->
              </tbody>
            </table>
          </div>
          <p id="livechatLobbyEmpty" class="lobby-empty">
            í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ìƒë‹´ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
          </p>
        </div>

        <!-- ìµœê·¼ ìƒë‹´ ì„¸ì…˜ -->
        <div class="sub-card">
          <div class="sub-card-header">
            <div>
              <div class="sub-card-title">ìµœê·¼ ìƒë‹´ ì„¸ì…˜</div>
              <div class="sub-card-sub">ì €ì¥ëœ ìƒë‹´ ì„¸ì…˜ ìš”ì•½ì…ë‹ˆë‹¤.</div>
            </div>
          </div>

          {% if sessions %}
            <ul class="session-list" data-recent-url="{% url 'live_chat_recent_sessions' %}">
              {% for s in sessions %}
                <li class="session-item"
                    data-session-id="{{ s.id }}"
                    data-history-room="{{ s.room|default_if_none:s.code|default_if_none:s.id }}"
                    data-history-type="{{ s.get_session_type_display|default:s.session_type }}"
                    data-history-note="{{ s.session_note|default_if_none:s.memo|default_if_none:s.note }}"
                    data-history-memo="{{ s.memo }}">
                  <div class="session-top-row">
                    <span class="code-pill">
                      {% if s.code %}{{ s.code }}{% else %}#{{ s.id }}{% endif %}
                    </span>

                    {% if s.status %}
                      {% if s.status|stringformat:"s" == "ëŒ€ê¸°" %}
                        <span class="status-tag status-wait">ëŒ€ê¸°</span>
                      {% elif s.status|stringformat:"s" == "ì§„í–‰" %}
                        <span class="status-tag status-wait">ì§„í–‰</span>
                      {% elif s.status|stringformat:"s" == "ì¢…ë£Œ" or s.status|stringformat:"s" == "ended" %}
                        <span class="status-tag status-done">ì¢…ë£Œ</span>
                      {% else %}
                        <span class="status-tag">{{ s.status }}</span>
                      {% endif %}
                    {% endif %}

                    <!-- ğŸ”¹ ê°œë³„ ì‚­ì œ ë²„íŠ¼ -->
                    <button type="button"
                            class="session-delete-btn"
                            title="ì´ ìƒë‹´ ê¸°ë¡ ì‚­ì œ"
                            data-delete-session-id="{{ s.id }}"
                            data-delete-url="{% url 'live_chat_cleanup' %}">
                      ì‚­ì œ
                    </button>
                  </div>

                  {# ë¬¸ì˜ ìœ í˜• + ë©”ëª¨ í•œ ì¤„ (ê´„í˜¸/with ì—†ì´ ìˆœìˆ˜ ifë§Œ ì‚¬ìš©) #}
                  {% if s.get_session_type_display or s.session_type or s.session_note or s.memo or s.note %}
                    <div class="meta meta-line">
                      {% if s.get_session_type_display or s.session_type %}
                        ìœ í˜•: {{ s.get_session_type_display|default:s.session_type }}
                      {% endif %}

                      {% if s.get_session_type_display or s.session_type %}
                        {% if s.session_note or s.memo or s.note %}
                          &nbsp;Â·&nbsp;
                        {% endif %}
                      {% endif %}

                      {% if s.session_note or s.memo or s.note %}
                        ë©”ëª¨:
                        {{ s.session_note|default_if_none:s.memo|default_if_none:s.note|truncatechars:40 }}
                      {% endif %}
                    </div>
                  {% endif %}

                  <div class="meta meta-line">
                    {% if s.room %}ë£¸: {{ s.room }} Â· {% endif %}
                    {% if s.created_at %}
                      {{ s.created_at|date:"Y-m-d H:i" }}
                    {% elif s.requested_at %}
                      {{ s.requested_at|date:"Y-m-d H:i" }}
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
              {% include "ragadmin/_live_chat_session_items.html" %}
            </ul>
          {% else %}
            <p class="meta">ìµœê·¼ ì €ì¥ëœ ìƒë‹´ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
      </section>

      <!-- RIGHT: ì„ íƒí•œ ìƒë‹´ ë°© -->
      <section class="card card-right">
        <div class="card-header">
          <div>
            <div class="card-title">ì„ íƒí•œ ìƒë‹´ ë°©</div>
            <p class="card-sub">
              ì™¼ìª½ ëŒ€ê¸° ëª©ë¡ì—ì„œ â€œì—°ê²°â€ì„ ëˆ„ë¥¸ ë’¤ ì´ê³³ì—ì„œ ëŒ€í™”í•©ë‹ˆë‹¤.
            </p>
          </div>
          <div class="card-right-side">
            <div id="livechatRoomStatus" class="room-status">
              <span class="lc-dot-offline"></span> ì—°ê²°ë˜ì§€ ì•ŠìŒ
            </div>
            <button type="button"
                    class="end-btn"
                    id="livechatEndBtn"
                    disabled>
              ìƒë‹´ ì¢…ë£Œ
            </button>
          </div>
        </div>

        <!-- ë°© í—¤ë”: ë°© ID + í˜ì´ì§€/ì‹œì‘/ì½”ë“œ ì •ë³´ -->
        <div class="room-header">
          <div class="room-header-left">
            <span class="room-header-label">í˜„ì¬ ë°©</span>
            <span id="livechatRoomIdLabel" class="room-id-label">
              ë°©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”
            </span>
          </div>
          <div class="room-header-right">
            <div class="room-meta-line">
              <span class="room-meta-label">í˜ì´ì§€</span>
              <span class="room-meta-value" id="livechatRoomPage">-</span>
            </div>
            <div class="room-meta-line">
              <span class="room-meta-label">ì‹œì‘</span>
              <span class="room-meta-value" id="livechatRoomStartedAt">-</span>
            </div>
            <div class="room-meta-line">
              <span class="room-meta-label">ì½”ë“œ</span>
              <span class="room-meta-value" id="livechatRoomCode">-</span>
            </div>
          </div>
        </div>

        <div class="room-body">
          <div id="livechatRoomEmpty" class="room-empty">
            ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
          <div id="livechatRoomMessages"></div>
        </div>

        <!-- í€µ ë‹µë³€ + ì…ë ¥ í¼ -->
        <form id="livechatRoomForm">
          <div class="quick-replies">
            <span class="quick-replies-title">í€µ ë‹µë³€:</span>
            <button type="button"
                    class="qr-btn"
                    data-snippet="ì•ˆë…•í•˜ì„¸ìš” ê¹€ë™ê±´ì˜ í¬íŠ¸í´ë¦¬ì˜¤ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?">
              ê¸°ë³¸ ì¸ì‚¬
            </button>
            <button type="button"
                    class="qr-btn"
                    data-snippet="ì ì‹œ í™•ì¸í•´ë³´ê³  ë‹¤ì‹œ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.">
              í™•ì¸ ì¤‘ ì•ˆë‚´
            </button>
            <button type="button"
                    class="qr-btn"
                    data-snippet="ìƒë‹´ ë„ì™€ë“œë¦´ ìˆ˜ ìˆëŠ” ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ê¸° ë•Œë¬¸ì— ìì„¸í•œ ì•ˆë‚´ê°€ ì–´ë µìŠµë‹ˆë‹¤. ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.">
              ë²”ìœ„ ë°– ì•ˆë‚´
            </button>
            <button type="button"
                    class="qr-btn"
                    data-snippet="ìƒë‹´ì„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ ê¸°ë»¤ìŠµë‹ˆë‹¤. ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.">
              ë§ˆë¬´ë¦¬ ì¸ì‚¬
            </button>
          </div>

          <div class="room-input-row">
            <textarea
              id="livechatRoomInput"
              placeholder="ìƒë‹´ì‚¬ ë©”ì‹œì§€ë¥¼ ì…ë ¥ í›„ Enter (Shift+Enter: ì¤„ë°”ê¿ˆ)"
            ></textarea>
            <button type="submit" class="send-btn">ì „ì†¡</button>
          </div>
        </form>

        <!-- ì„¸ì…˜ ë©”íƒ€(ìœ í˜•/ë©”ëª¨/ìƒì„¸ ê¸°ë¡) -->
        <section class="session-meta">
          <div class="session-meta-col">
            <label for="sessionType" class="session-meta-label">
              ë¬¸ì˜ ìœ í˜• (ì„ íƒ)
            </label>
            <select id="sessionType">
              <option value="">ì„ íƒ ì•ˆ í•¨</option>
              <option value="signup">ê°€ì…/ë¡œê·¸ì¸</option>
              <option value="billing">ìš”ê¸ˆ/ê²°ì œ</option>
              <option value="tech">ê¸°ìˆ  ë¬¸ì˜</option>
              <option value="etc">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="session-meta-col">
            <label for="sessionNote" class="session-meta-label">
              ì„¸ì…˜ ë©”ëª¨ (ì„ íƒ)
            </label>
            <input
              id="sessionNote"
              type="text"
              placeholder="ì˜ˆ: ê²°ì œ ì˜¤ë¥˜ ë¬¸ì˜, ì½œë°± ìš”ì²­ ì—†ìŒ"
            />
          </div>

          <div class="session-detail-row">
            <label for="sessionDetail" class="session-meta-label">
              ìƒì„¸ ìƒë‹´ ê¸°ë¡
            </label>
            <textarea
              id="sessionDetail"
              class="session-detail-input"
              placeholder="ìƒë‹´ ìš”ì•½, ë‹¤ìŒì— ì´ì–´ì„œ ì°¸ê³ í•  ë‚´ìš© ë“±ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”."
            ></textarea>
          </div>

          <!-- ğŸ”¹ ìƒë‹´ ê¸°ë¡ ì €ì¥ ë²„íŠ¼ + ìƒíƒœ í‘œì‹œ -->
          <div class="session-actions-row">
            <button
              type="button"
              id="sessionSaveBtn"
              class="session-save-btn send-btn"
              data-save-url="/api/livechat/save-session/">
              ìƒë‹´ ê¸°ë¡ ì €ì¥
            </button>
            <span
              id="sessionStatusPill"
              class="session-status-pill session-status-pill--idle"
              aria-live="polite">
              ì§„í–‰ ì¤‘ Â· ì €ì¥ ì¤€ë¹„
            </span>
          </div>
        </section>
      </section>
    </div>
  </div>

  <!-- ì•Œë¦¼ìŒ -->
  <audio id="livechatNotifySound" preload="auto">
    <source src="{% static 'ragapp/sounds/notify.mp3' %}" type="audio/mpeg" />
  </audio>

  <script
    src="{% versioned_static 'ragapp/javascript/livechat_admin.js' %}"
    {% if csp_nonce %}nonce="{{ csp_nonce }}"{% endif %}>
  </script>
</body>
</html>
